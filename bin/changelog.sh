#!/bin/bash

cd "$(dirname $0)/.."

gitprojecturl=$(git config --get remote.origin.url|sed 's/.git$//g')
previous_tag=0
stringOutput=""

printHeadTable()
{
    tag=$1
    date=$2
    stringOutput="${stringOutput}## ${tag} (${tag_date})\n\n"
    stringOutput="${stringOutput}|Author|Description|Date|Commit|\n"
    stringOutput="${stringOutput}|---|---|---|---|\n"
}

for current_tag in $(git tag --sort=-creatordate)
do
    if [ "$previous_tag" != 0 ]
    then
        tag_date=$(git log -1 --pretty=format:'%ad' --date=short ${previous_tag})
        printHeadTable ${previous_tag} ${tag_date}        
        value=$(git log ${current_tag}...${previous_tag} --pretty=format:"|%cn|%s|%cd|[%h]("${gitprojecturl}"/commits/%H)|" --reverse | grep -v Merge)
    else
        tag_date=$(git log -1 --pretty=format:'%ad' --date=short)
        printHeadTable ${current_tag} ${tag_date}
        value=$(git log --pretty=format:"|%cn|%s|%cd|[%h]("${gitprojecturl}"/commits/%H)|" --reverse | grep -v Merge)
        stringOutput="${stringOutput}${value}\n"
    fi
    stringOutput="${stringOutput}\n\n"
    previous_tag=${current_tag}
done

echo -e "# Release changelog\n" > changelog.md
echo -e "Autogenerated Kid Logger change log file.\n" >> changelog.md
echo -e "${stringOutput}" >> changelog.md